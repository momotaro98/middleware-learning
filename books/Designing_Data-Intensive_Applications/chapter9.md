---
marp: true
---

# Chapter 9 一貫性と合意

トランザクションがアプリケーションに対してAID(ACIDのCが無い)を提供しシステムの問題を無いように振る舞う抽象化であるように、
8章での分散システムの問題(※)をアプリケーションにとって抽象化したものの概念の1つが**合意(consensus)**である。

> ※: すなわちパケットはロストし、順序は狂い、複製され、ネットワークでどれだけの遅延が生じるかわかりません。クロックはせいぜい大まかにしか正しくありません。ノードは(たとえばGCのため)いつクラッシュしたりするか分かりません。

-----

## 9.1 一貫性の保証

結果整合性(eventual consistency)は正しいデータ状態へと収束するので**収束性(convergence)**の方が適切な名前かもしれない。

結果整合性は**弱い**保証であり、レプリカが**いつ**収束するのかについては何も語らない。

弱い一貫性と強い一貫性の関係は、トランザクション分離レベルの強さに類似点がある。(強さを上げるとパフォーマンスに影響するところ)

ただし、それぞれ注目していることが独立している。トランザクション分離の主眼は、並行してトランザクションの実行することから生じるレース条件を避けることにあるのに対し、分散の一貫性が主眼とするのは遅延やフォールトに際してレプリカの状態を調整することにある。

強い一貫性の代表が**線形化可能性**である。

-----

## 9.2 線形化可能性

レプリケーションが複数台あるときに一度どこかのレプリケーションから最新が返されたらそれ以降はどのレプリケーションはその最新よりも古い値を返さない保証が、**線形化可能性(linearizability)**である。
→ **最新性の保証(recency guarantee)**

線形化可能性は、原子的一貫性、強い一貫性、即時一貫性、外部一貫性、と呼ばれることもある。

-----

TODO: 図9-4

それぞれの四角い棒はクライアントが発行したリクエストであり、棒の開始点はリクエストが送信された時刻、そして棒の終末点はクライアントがレスポンスを受信した時点である。

-----

### 9.2.2 線形化可能性が必要なケース (書籍では"線形化可能性への依存")

* レプリケーションのLeader選出
  * 単一Leaderのレプリケーション選出には本当にLeaderが1つしかないことを保証する必要がある。
  * Lockを使うことになる。Lockの実装がなんであれ、線形化可能性である必要がある。
  * 分散LockやLeader選出の実装にはZooKeeperやetcdのような協調サービス(合意アルゴリズム)が利用される。
* ユニーク性制約の保証
  * RDBMSでの2つの重複データのどちらかが書き込み時にエラーになるデータユニーク制約は線形化可能性が求められる。
  * この状況はLockに似ている。
* クロスチャンネルタイミング依存関係
  * ファイルストレージとキュー、などの独立した2つの通信チャネルを利用するようなシステムでは順序の逆転があってはいけない場合があり、線形化可能性を保証する必要がある。

-----

### 9.2.3 線形化可能性なシステムの実装

* シングルLeaderレプリケーション
  * → すべてが線形化可能なわけではない
* 合意アルゴリズム
  * → 線形化可能
* マルチLeaderレプリケーション
  * → 線形化可能ではない
* Leaderレスレプリケーション
  * → 線形化可能にはならないケースが存在する

-----
### CAP定理

以下のトレードオフがある。

* アプリケーションの線形化可能が**必須の**要件の場合、
  * ネットワーク障害がある際はレプリカを利用することは**できない**。
* アプリケーションの線形化可能が**必須ではない**要件の場合、
  * ネットワーク障害がある際はレプリカを利用することが**できる**。

-----

#### [役に立たないCAP定理]

> CAPは、Consistency、Availability、Partition toleranceの3つの中から2つを選択することとされます。しかしこれは誤解を招きます。ネットワークの分断はフォールトの一種なので、選択に関係するようなものではなく、好むと好まざるとに関わらず生じるものです。
> ネットワークが正常に動作しているなら、システムは一貫性(線形化可能性)と完全な可用性をどちらも提供できます。ネットワークにフォールトが生じると、線形化可能性と完全な可用性のどちらかを選択しなければなりません。したがって、CAPを表現するなら**ネットワーク分断が生じた時に一貫性と可用性のどちらかを選ぶのか**、という方が良いでしょう。
> CAPには歴史的に大きな影響力があったものの、システムの設計における実際的な価値はほとんどないのです。

-----

#### 9.2.4.2 線形化可能性とネットワークの遅延

マルチコアCPUのRAMをはじめ、多くの分散データベースでも線形化可能性を切り捨てている理由はパフォーマンスであり、耐障害性ではない。線形化可能性を提供すれば速度は落ちる。

> もっと効率的な線形化可能なストレージの実装は無いのでしょうか？その答えは「無い」だと思われます。AttiyaとWelchは、線形化可能性が求めるのであれば、読み書きのリクエストに対するレスポンスタイムは、少なくともネットワークの遅延の不確実性に比例することを証明しました。
> 線形化可能性を持つ高速なアルゴリズムは存在しませんが、もっと弱い一貫性モデルははるかに高速化できるので、レイテンシに敏感なシステムにおいてこのトレードオフは重要なのです。

-----

## 9.3 順序の保証